#!/usr/bin/env bash
: <<'COPYRIGHT'
 Copyright (c) Vaimo Group. All rights reserved.
 See LICENSE_VAIMO.txt for license details.
COPYRIGHT

script_path=${BASH_SOURCE[0]}
script_root=$(dirname $(test -L ${script_path} && readlink -f ${script_path} || echo ${script_path}))

source ${script_root}/lib/output.sh

run_tests() {
    local scenario_root=${1}
        
    local scenario_label=$(cat ${scenario_root}/.label)
    local commands=$(cat ${scenario_root}/.commands)
        
    _line '-' 80
    _info "SCENARIO:" "${scenario}" "${scenario_label}"
    _line '-' 80
            
    rm -rf patches 2>/dev/null
    rm patches.json 2>/dev/null
    rm output.out 2>/dev/null
    rm output.txt 2>/dev/null

    local original_ifs=${IFS}
    IFS=$'\n'
    
    for dependency in $(ls -1 ${scenario_root}/files) ; do
        cp -R ${scenario_root}/files/${dependency} ${dependency}
    done 
        
    local should_fail
    local assertions=

    for command in ${commands} ; do
        should_fail=0
        system_call=0

        if [ "${command:0:1}" == "!" ] ; then
            _warning "EXPECTING FAILURE"
            should_fail=1
        fi
        
        command=$(echo ${command}|sed 's/^\!*//g')
    
        if [ "${command:0:1}" == "@" ] ; then
            if process_assertions "${command}" ; then
                continue
            fi
            
            return 1
        fi
        
        if [ "${command:0:1}" == ">" ] ; then
            system_call=1
        fi
    
        command=$(echo ${command}|sed 's/^>*//g')
    
        if [ ${system_call} -eq 0 ] ; then
            apply_patches "${command}" "output.out"            
        else 
            _warning "SYSTEM: ${command}"
            eval "${command}"
        fi
        
        local result=${?}
    
        if ( [ ${result} -eq 0 ] && [ ${should_fail} -eq 0 ]) \
            || ([ ${result} -gt 0 ] && [ ${should_fail} -eq 1 ] \
        ) ; then
            continue
        fi

        return 1
    done
    
    if [ -d patches ] ; then
        for patch_file in $(find -L patches -type f) ; do
            assertions="${assertions}\n"$(cat ${patch_file}|grep '@assert')
        done
    fi
    
    if [ "${assertions}" != "" ] && ! process_assertions ${assertions}; then
        return 1
    fi
    
    IFS=${original_ifs}
    
    if ! assert_scenario_output "${scenario_root}" "output.out" ; then
        return 1
    fi 
    
    return 0
}

assert_scenario_output() {
    local scenario_root=${1}
    local output_file=${2}
    
    local expected_output_file="${scenario_root}/.output"
 
    if [ ! -f ${output_file} ] ; then
        return 0
    fi
 
    cat ${output_file} \
        |sed -r "s/[[:cntrl:]]\[[0-9]{1,3}m//g" \
        |sed -r "s/\x1B\[([0-9]{1,2}(;[0-9]{1,2})?)?[m|K]//g" \
        |grep -v "^You are running composer with xdebug enabled" \
        |grep -v "^patch:apply" \
        |grep -v "^patch:list" \
        |grep -v "^patch:validate" \
        |grep -v "^patch:redo" \
        |grep -v "^patch:undo" \
        > output.txt
        
    rm ${output_file} 2>/dev/null

    if [ ! -f ${expected_output_file} ] ; then
        return 0
    fi

    local diff_out=$(diff -u ${expected_output_file} output.txt|grep -v '^\(+++\|---\|@@\)')
                
    if [ "${diff_out}" == "" ] ; then
        return 0
    fi
    
    echo ''
    _error "ERROR: output differs from what is expected:"            
    
    _line '↓' 80
    echo "${diff_out}"
    _line '↑' 80
    
    echo ''
            
    return 1 
}

process_assertions() {
    local assertions=${1}
        
    local assertions=$(echo -e "${assertions}"|cut -d' ' -f2)

    local original_ifs=${IFS}
    IFS=$'\n'
    
    for assertion in ${assertions} ; do
        if [ "${assertion}" == "" ] ; then
            continue
        fi
        if assert ${assertion} ; then
            continue
        fi
            
        assertion_error "${patch_file}" "${assertion}"
                        
        return 1
    done
    
    IFS=${original_ifs}
    
    return 0
}

function apply_patches() {   
    local args=${1}
    local out_file=${2}
 
    local command="COMPOSER_PATCHES_FATAL_FAIL=1 composer ${args} --ansi"
 
    if [ "${VERBOSE}" == "1" ] ; then
        command="${command} -vvv"
    fi
 
    if [ "${out_file}" != "" ] ; then
        command="${command} &> >(tee -a ${out_file})"
    fi
 
    eval "${command}; return \${PIPESTATUS[0]}"
        
    local result=${?}
    
    return ${result};
}

assert() {
    assertion=${1}
    invert=${2}

    local name=$(echo ${assertion}|cut -d',' -f1)
    local before=$(echo ${assertion}|cut -d',' -f2)
    local after=$(echo ${assertion}|cut -d',' -f3)

    local contents=$(cat vendor/${name}/src/example.txt)

    if [ "${invert}" != "" ] && [ "${invert}" != "0" ] ; then
        local tmp=${before}
        before=${after}
        after=${tmp}
    fi

    if echo "${contents}"|grep -qw "^${before}" && [ "${before}" == "${after}" ] ; then
        return 0
    fi
        
    if ! echo "${contents}"|grep -qw "^${before}" && echo "${contents}"|grep -qw "^${after}" ; then
        return 0
    fi
    
    return 1
}

assertion_error() {
    patch_file=${1}
    assertion=${2}
    invert=${3}

    local name=$(echo ${assertion}|cut -d',' -f1)
    local before=$(echo ${assertion}|cut -d',' -f2)
    local after=$(echo ${assertion}|cut -d',' -f3)

    local file=vendor/${name}/src/example.txt

    local contents=$(cat ${file})

    if [ "${invert}" != "" ] && [ "${invert}" != "0" ] ; then
        local tmp=${before}
        before=${after}
        after=${tmp}
    fi

    _error "PATCH: $(readlink -f ${patch_file})"
    _error "TARGET: ${file}"
    _error "ASSERTION: ${before} => ${after}"        
}

function reset_packages() {
    local installation_root=${1}
    local install_info_path="${installation_root}/vendor/composer/installed.json"
    
    if [ -f ${install_info_path} ] ; then
        sudo sed -i 's|\s"name":\s"vaimo/composer-patches-target\(.*\)",| \
            "name": "__vaimo/composer-patches-target\1",|g' \
            ${install_info_path}
    fi
    
    composer install --ansi --no-plugins &>/dev/null
}

sanitize() {
    rm -rf patches 2>/dev/null
    rm -rf modules 2>/dev/null
    rm -rf scenarios 2>/dev/null
    rm patches.json 2>/dev/null    
}

sanitize_scenario() {    
    local scenario_root=${1}
    
    for dependency in $(ls -1 ${scenario_root}/files) ; do
        rm -rf ${dependency} 2>/dev/null   
    done 
}

get_installation_root() {
    local installation_name=${1}

    (
        cd installations/${installation_name} &>/dev/null
        pwd
    )
}

scenario_filter=${1}

if echo "${scenario_filter}"|grep -q ':' ; then
    installation_filter=$(echo "${scenario_filter}"|cut -d':' -f1)
    scenario_filter=$(echo "${scenario_filter}"|cut -d':' -f2)
else 
    installation_filter=".*"
fi

if [ "${scenario_filter}" == "" ] ; then
    scenario_filter=".*"
fi

(
    package_root=$(pwd)
     
    cd ${package_root}/test &>/dev/null
    
    sandbox_root=$(pwd)
    
    installations=$(ls installations -1)
    scenarios=$(ls scenarios -1)
    
    if [ "${PURGE}" == "1" ] ; then
        for installation in ${installations} ; do
            installation_root=$(get_installation_root ${installation})
        
            rm "${installation_root}/composer.lock" 2>/dev/null
        done
    fi
    
    for installation in ${installations} ; do
        if ! echo ${installation}|grep -q "${installation_filter}" ; then
            continue
        fi

        installation_root=$(get_installation_root ${installation})

        installation_label=$(cat ${installation_root}/.label)
        scenarios_skip=$(cat ${installation_root}/.skip 2>/dev/null)
    
        _line '=' 80
        _title "INSTALLATION:" "${installation}" "${installation_label}"
        _line '=' 80
        
        (
            cd ${installation_root}
        
            sanitize

            ln -s ${sandbox_root}/modules ${installation_root}
            
            composer install --ansi --no-plugins
    
            for scenario in ${scenarios} ; do
                if [ "${scenarios_skip}" != "" ] && echo "${scenarios_skip}"|grep -q "^${scenario}$" ; then
                    continue
                fi
            
                if ! echo ${scenario}|grep -q "${scenario_filter}" ; then
                    continue
                fi
            
                reset_packages "${installation_root}"

                scenario_root=${sandbox_root}/scenarios/${scenario}
                        
                if ! run_tests "${scenario_root}" ; then
                    sanitize
                    sanitize_scenario ${scenario_root}
                    exit 1
                else 
                    sanitize_scenario ${scenario_root}
                fi
            done
            
            echo ''
        
            sanitize
            
            exit 0
        )
        
        if [ ${?} != 0 ] ; then
            _line '▚' 80
            _error "FAIL" 
            exit 1
        fi
    done

    _line '▚' 80
    _info "SUCCESS"
    
    exit 0    
)
